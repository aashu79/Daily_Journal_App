@page "/journal"
@page "/journal/{EntryId:int}"
@implements IDisposable
@using Daily_Journal_App.Services
@using Daily_Journal_App.Models
@inject IJSRuntime JS
@inject JournalService JournalService
@inject MoodService MoodService
@inject TagService TagService
@inject NavigationManager Navigation

<div style="max-width: 800px; margin: 0 auto; padding: 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 class="mb-4">Daily Journal</h3>
        <div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="BackToEntries">← Back to All Entries</button>
            <button class="btn btn-outline-primary btn-sm ms-2" @onclick="ExportEntry">Export</button>
        </div>
    </div>

    @if (entry == null)
    {
        <div class="empty-state p-4 text-center" style="border: 1px dashed #ccc; border-radius: 8px;">
            <p class="text-muted">No entry for today.</p>
            <button class="btn btn-primary mt-2" @onclick="CreateEntry">Start Writing</button>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header bg-light">
                <strong>@entry.Date.ToString("dddd, MMMM dd, yyyy")</strong>
                @if (entry.UpdatedAt != default)
                {
                    <small class="d-block text-muted">Last saved: @entry.UpdatedAt.ToString("g")</small>
                }
            </div>
            <div class="card-body">
                <!-- Title -->
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" @bind="entry.Title" placeholder="Enter a title for your entry" maxlength="200" />
                </div>

                <!-- Mood -->
                <div class="mb-3">
                    <label class="form-label">How are you feeling today?</label>
                    <select class="form-select" @bind="selectedPrimaryMood">
                        <option value="">— Select Primary Mood —</option>
                        @foreach (var mood in primaryMoods)
                        {
                            <option value="@mood.Name">@mood.Name (@mood.MoodType)</option>
                        }
                    </select>

                    <div class="mt-2">
                        <label class="form-label">Secondary Moods (optional, up to 2)</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" @bind="selectedSecondaryMood1">
                                <option value="">Select</option>
                                @foreach (var mood in secondaryMoods.Where(m => m.Name != selectedPrimaryMood))
                                {
                                    <option value="@mood.Name">@mood.Name (@mood.MoodType)</option>
                                }
                            </select>
                            <select class="form-select" @bind="selectedSecondaryMood2">
                                <option value="">Select</option>
                                @foreach (var mood in secondaryMoods.Where(m => m.Name != selectedPrimaryMood && m.Name != selectedSecondaryMood1))
                                {
                                    <option value="@mood.Name">@mood.Name (@mood.MoodType)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Content with Quill Editor -->
                <div class="mb-3">
                    <label class="form-label">Your thoughts for today</label>
                    <div id="quill-editor" style="height: 300px; background: white;"></div>
                </div>

                <!-- Tags -->
                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <input class="form-control" @bind="selectedTags" placeholder="work, personal, goals" />
                    @if (!string.IsNullOrWhiteSpace(selectedTags))
                    {
                        <div class="selected-tags mt-2">
                            <small class="text-muted">Tags: @string.Join(", ", selectedTags.Split(',').Where(t => !string.IsNullOrWhiteSpace(t)).Select(t => t.Trim()))</small>
                        </div>
                    }

                    @if (allTags != null && allTags.Any())
                    {
                        <div class="mt-2">
                            <small class="text-muted">Suggestions:</small>
                            <div class="d-flex flex-wrap gap-2 mt-1">
                                @foreach (var t in allTags)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AddTagSuggestion(t.Name)">@t.Name</button>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-end gap-2">
                    @if (isEditing)
                    {
                        <button class="btn btn-outline-danger" @onclick="Delete">Delete</button>
                    }
                    <button class="btn btn-outline-secondary" @onclick="BackToEntries">Cancel</button>
                    <button class="btn btn-success" @onclick="Save">Save</button>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert alert-info mt-3">@statusMessage</div>
        }
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" style="position: fixed; top: 20px; right: 20px; z-index: 1000;" @onclick="ClearError">
        @errorMessage
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success" style="position: fixed; top: 20px; right: 20px; z-index: 1000;" @onclick="ClearSuccess">
        @successMessage
        <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
    </div>
}

@code {
    [Parameter]
    public int? EntryId { get; set; }

    private JournalEntry? entry;
    private string errorMessage = "";
    private string successMessage = "";
    private string statusMessage = "";
    private bool isInitialized = false;

    private List<Mood> primaryMoods = new();
    private List<Mood> secondaryMoods = new();
    private List<Tag> allTags = new();

    // store selected values as names (strings)
    private string selectedPrimaryMood = "";
    private string selectedSecondaryMood1 = "";
    private string selectedSecondaryMood2 = "";
    private string selectedTags = "";

    private bool forceNew = false;
    private bool isEditing = false;

    private DotNetObjectReference<JournalWrite>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoodsAndTags();

        // Detect query parameter ?new=true
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            if (!string.IsNullOrEmpty(uri.Query) && uri.Query.Contains("new=true", StringComparison.OrdinalIgnoreCase))
            {
                forceNew = true;
            }
        }
        catch { }

        await LoadEntry();
    }

    private async Task LoadMoodsAndTags()
    {
        try
        {
            primaryMoods = await MoodService.GetMoodsByCategoryAsync("Primary");
            secondaryMoods = await MoodService.GetMoodsByCategoryAsync("Secondary");
            allTags = await TagService.GetAllTagsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading moods/tags: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize Quill whenever the entry is available and we haven't already initialized
        if (entry != null && !isInitialized)
        {
            try
            {
                await Task.Delay(100);

                // Create a dotnet reference so JS can call back OnQuillTextChanged
                dotNetRef = DotNetObjectReference.Create(this);

                // Pass dotNetRef to the initialization so the text-change handler can call back
                await JS.InvokeVoidAsync("initQuillEditor", "quill-editor", dotNetRef);

                // If the entry has existing content, set it in the editor
                if (!string.IsNullOrWhiteSpace(entry.Content))
                {
                    await JS.InvokeVoidAsync("setQuillContent", entry.Content);
                }

                isInitialized = true;
            }
            catch (Exception ex)
            {
                errorMessage = $"Editor initialization failed: {ex.Message}";
                Console.WriteLine($"Quill init error: {ex}");
            }
        }
    }

    private async Task LoadEntry()
    {
        try
        {
            if (EntryId.HasValue && EntryId.Value > 0)
            {
                // Load existing entry for editing
                entry = await JournalService.GetEntryAsync(EntryId.Value);
                if (entry == null)
                {
                    errorMessage = "Entry not found.";
                }
                else
                {
                    isEditing = true;
                    // Set selected mood names
                    selectedPrimaryMood = entry.PrimaryMood ?? "";
                    selectedSecondaryMood1 = entry.SecondaryMoods?.Split(',').FirstOrDefault()?.Trim() ?? "";
                    selectedSecondaryMood2 = entry.SecondaryMoods?.Split(',').Skip(1).FirstOrDefault()?.Trim() ?? "";

                    // Set selected tags
                    selectedTags = entry.Tags ?? "";
                }
            }
            else if (forceNew)
            {
                // Explicit new entry requested — start with a blank entry
                entry = new JournalEntry
                {
                    Date = DateTime.Today,
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now
                };
                isEditing = false;
                statusMessage = "Creating new entry.";
            }
            else
            {
                // Default behavior: do NOT auto-load today's entry. Start with a blank form for new entry.
                entry = new JournalEntry
                {
                    Date = DateTime.Today,
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now
                };
                isEditing = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading entry: {ex.Message}";
            Console.WriteLine($"LoadEntry error: {ex}");
        }
    }

    private void CreateEntry()
    {
        entry = new JournalEntry 
        { 
            Date = DateTime.Today,
            CreatedAt = DateTime.Now,
            UpdatedAt = DateTime.Now
        };
        selectedPrimaryMood = "";
        selectedSecondaryMood1 = "";
        selectedSecondaryMood2 = "";
        selectedTags = "";
        isEditing = false;
        statusMessage = "Creating new entry.";
        StateHasChanged();
    }

    private async Task Save()
    {
        try
        {
            errorMessage = "";
            successMessage = "";
            statusMessage = "";

            if (entry == null) return;

            // Validate
            if (string.IsNullOrWhiteSpace(entry.Title))
            {
                errorMessage = "Please enter a title.";
                return;
            }

            if (string.IsNullOrWhiteSpace(selectedPrimaryMood))
            {
                errorMessage = "Please select your primary mood.";
                return;
            }

            // Get content from Quill editor
            if (isInitialized)
            {
                try
                {
                    entry.Content = await JS.InvokeAsync<string>("getQuillContent");
                }
                catch (Exception ex)
                {
                    errorMessage = $"Failed to get editor content: {ex.Message}";
                    return;
                }
            }

            if (string.IsNullOrWhiteSpace(entry.Content))
            {
                errorMessage = "Please write some content.";
                return;
            }

            // Set mood and tag names directly
            entry.PrimaryMood = selectedPrimaryMood;
            entry.SecondaryMoods = string.Join(", ", new[] { selectedSecondaryMood1, selectedSecondaryMood2 }.Where(s => !string.IsNullOrEmpty(s)));
            entry.Tags = selectedTags.Trim();

            // Determine whether save will update an existing entry for the date
            var existingForDate = await JournalService.GetEntryByDateAsync(entry.Date == default ? DateTime.Today : entry.Date);
            var willUpdate = existingForDate != null && existingForDate.Id != entry.Id;

            // Save entry
            var result = await JournalService.SaveEntryAsync(entry);
            
            if (result > 0)
            {
                // no tag-id linking; tags are stored as names in entry.Tags
                successMessage = willUpdate || isEditing ? "Entry updated successfully!" : "Entry created successfully!";
                statusMessage = willUpdate || isEditing ? "Updated existing entry." : "Created new entry.";

                var primaryMood = primaryMoods.Concat(secondaryMoods).FirstOrDefault(m => m.Name == selectedPrimaryMood);
                if (primaryMood != null)
                {
                    statusMessage += $" Primary mood: {primaryMood.Name}.";
                }

                await Task.Delay(1000);
                Navigation.NavigateTo("/entries");
            }
            else
            {
                errorMessage = "Failed to save entry.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving entry: {ex.Message}";
            Console.WriteLine($"Save error: {ex}");
        }
    }

    private async Task Delete()
    {
        try
        {
            if (entry == null || entry.Id == 0) return;

            var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
            
            if (confirmed)
            {
                await JournalService.DeleteEntryAsync(entry);
                successMessage = "Entry deleted successfully!";
                await Task.Delay(1000);
                Navigation.NavigateTo("/entries");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting entry: {ex.Message}";
        }
    }

    private void BackToEntries()
    {
        Navigation.NavigateTo("/entries");
    }

    private void ClearError()
    {
        errorMessage = "";
    }

    private void ClearSuccess()
    {
        successMessage = "";
    }

    private async Task ExportEntry()
    {
        try
        {
            if (entry == null) return;

            // Build simple HTML export
            var html = $"<html><head><meta charset=\"utf-8\"><title>{System.Net.WebUtility.HtmlEncode(entry.Title)}</title></head><body>" +
                       $"<h1>{System.Net.WebUtility.HtmlEncode(entry.Title)}</h1>" +
                       $"<p><em>{entry.Date:dddd, MMMM dd, yyyy}</em></p>" +
                       $"<p><strong>Mood:</strong> {System.Net.WebUtility.HtmlEncode(entry.PrimaryMood)}" +
                       (!string.IsNullOrWhiteSpace(entry.SecondaryMoods) ? $" (Secondary: {System.Net.WebUtility.HtmlEncode(entry.SecondaryMoods)})" : "") +
                       $"</p>" +
                       $"<hr/>" +
                       entry.Content +
                       $"</body></html>";

            var filename = $"journal-{entry.Date:yyyy-MM-dd}.html";
            await JS.InvokeVoidAsync("downloadFile", filename, html, "text/html");
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
    }

    private void AddTagSuggestion(string tag)
    {
        var list = (selectedTags ?? string.Empty).Split(',').Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)).ToList();
        if (!list.Contains(tag, StringComparer.OrdinalIgnoreCase))
        {
            list.Add(tag);
            selectedTags = string.Join(", ", list);
        }
    }

    // Called from JS when editor text changes
    [JSInvokable]
    public async Task OnQuillTextChanged()
    {
        try
        {
            if (entry != null && isInitialized)
            {
                var content = await JS.InvokeAsync<string>("getQuillContent");
                entry.Content = content;
                StateHasChanged();
            }
        }
        catch {
            // ignore errors from JS callback
        }
    }

    public void Dispose()
    {
        try
        {
            dotNetRef?.Dispose();
        }
        catch { }
    }
}

<style>
    .empty-state {
        background-color: #f9f9f9;
    }

    .tag-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 10px;
        background: #f8f9fa;
    }

    .tag-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 15px;
        background: white;
        border: 1px solid #dee2e6;
        transition: all 0.2s;
    }

    .tag-checkbox:hover {
        background: #e9ecef;
    }

    .tag-checkbox input[type="checkbox"] {
        margin: 0;
    }

    .tag-label {
        font-size: 0.9rem;
        user-select: none;
    }

    .selected-tags {
        padding: 8px;
        background: #e7f3ff;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }

    /* Quill editor custom styles */
    #quill-editor {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    :global(.ql-toolbar) {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }

    :global(.ql-container) {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
</style>