@page "/journals/view/{EntryId:int}"
@using Daily_Journal_App.Services
@using Daily_Journal_App.Models
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="journal-view container mt-3" style="max-width: 800px;">
    @if (entry == null)
    {
        <div class="alert alert-warning">Entry not found.</div>
    }
    else
    {
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-0">@entry.Title</h3>
                    <small class="text-muted">@entry.Date.ToString("dddd, MMMM dd, yyyy")</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" @onclick="Back">Back</button>
                    <button class="btn btn-sm btn-outline-primary me-2" @onclick="EditEntry">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="Delete">Delete</button>
                </div>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(entry.PrimaryMood))
                {
                    <p><strong>Mood:</strong> @entry.PrimaryMood</p>
                }

                @if (!string.IsNullOrWhiteSpace(entry.SecondaryMoods))
                {
                    <p class="text-muted">Secondary: @entry.SecondaryMoods</p>
                }

                <hr />

                <div class="journal-content">
                    @((MarkupString)entry.Content)
                </div>

                @if (!string.IsNullOrWhiteSpace(entry.Tags))
                {
                    <div class="mt-3">
                        <strong>Tags:</strong>
                        @foreach (var t in entry.Tags.Split(',').Select(x => x.Trim()).Where(x => !string.IsNullOrEmpty(x)))
                        {
                            <span class="badge bg-secondary me-1">@t</span>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int EntryId { get; set; }

    private JournalEntry? entry;

    protected override async Task OnInitializedAsync()
    {
        entry = await JournalService.GetEntryAsync(EntryId);
    }

    private void Back()
    {
        Navigation.NavigateTo("/entries");
    }

    private void EditEntry()
    {
        Navigation.NavigateTo($"/journal/{EntryId}");
    }

    private async Task Delete()
    {
        if (entry == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
        if (!confirmed) return;

        await JournalService.DeleteEntryAsync(entry);
        Navigation.NavigateTo("/entries");
    }
}
