@inherits LayoutComponentBase
@using Daily_Journal_App.Services
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject ThemeService ThemeService
@implements IDisposable

<!-- Root wrapper with theme class -->
<div class="dailyscript-layout @ThemeService.GetThemeClass()">

    <!-- Sidebar -->
    <nav class="ds-sidebar">
        <div class="ds-sidebar-header">
            <div class="ds-logo">DailyScript</div>
        </div>
        <div class="ds-nav">
            @if (AuthService.IsAuthenticated)
            {
                <a class="ds-nav-link @(IsActive("/dashboard") ? "active" : "")" href="/dashboard">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Dashboard
                </a>
                <!-- New Entry now explicitly indicates creation via query param -->
                <a class="ds-nav-link @(IsActive("/journal") ? "active" : "")" href="/journal?new=true">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    New Entry
                </a>
                <a class="ds-nav-link @(IsActive("/entries") ? "active" : "")" href="/entries">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    All Entries
                </a>
                <a class="ds-nav-link @(IsActive("/calendar") ? "active" : "")" href="/calendar">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Calendar
                </a>

                <!-- Split analytics into Streaks and Mood Tracker -->
                <a class="ds-nav-link @(IsActive("/streaks") ? "active" : "")" href="/streaks">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Streaks
                </a>
                <a class="ds-nav-link @(IsActive("/mood-tracker") ? "active" : "")" href="/mood-tracker">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Mood Tracker
                </a>

                @* <a class="ds-nav-link @(IsActive("/analytics") ? "active" : "")" href="/analytics">
                     Analytics
                </a> *@

                <!-- Export page link -->
                <a class="ds-nav-link @(IsActive("/export") ? "active" : "")" href="/export">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Export
                </a>

                <!-- Tag and Mood management links -->
                <a class="ds-nav-link @(IsActive("/moods") ? "active" : "")" href="/moods">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Moods
                </a>
                <a class="ds-nav-link @(IsActive("/tags") ? "active" : "")" href="/tags">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Tags
                </a>

                <!-- DB Info link -->
                @* <a class="ds-nav-link @(IsActive("/db-info") ? "active" : "")" href="/db-info">
                    db-info
                </a> *@
            }
        </div>
        <div class="ds-sidebar-footer">
            <button class="ds-nav-link theme-toggle" @onclick="ToggleTheme">
                <span class="ds-nav-icon" aria-hidden="true"></span>
                @(ThemeService.CurrentTheme == "dark" ? "Light" : "Dark") Mode
            </button>
            @if (AuthService.IsAuthenticated)
            {
                <button class="ds-nav-link logout-btn" @onclick="Logout">
                    <span class="ds-nav-icon" aria-hidden="true"></span>
                    Logout
                </button>
            }
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="ds-main">
        <main class="ds-content">
            @Body
        </main>
    </div>
</div>

<style>
    /* Keep a reserved icon column so text alignment remains consistent after removing emojis */
    .ds-sidebar { width: 220px; }
    .ds-logo { font-weight: 700; font-size: 1.05rem; padding: 12px 16px; }
    .ds-nav { padding: 8px 12px; }
    .ds-nav-link { display: flex; align-items: center; gap: 10px; padding: 8px 12px; color: inherit; text-decoration: none; border-radius: 6px; }
    .ds-nav-link:hover { background: rgba(0,0,0,0.03); }
    .ds-nav-link.active { background: rgba(0,0,0,0.06); font-weight: 600; }
    .ds-nav-icon { display: inline-block; width: 20px; text-align: center; visibility: hidden; }
    .ds-sidebar-footer { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .theme-toggle, .logout-btn { width: 100%; text-align: left; }
</style>

@code {
    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        ThemeService.OnThemeChanged += StateHasChanged;
        
        // Redirect to login if not authenticated
        if (!AuthService.IsAuthenticated && !Navigation.Uri.Contains("/login"))
        {
            Navigation.NavigateTo("/login");
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // If user navigates to a protected route while not authenticated, redirect to login
        var relative = Navigation.ToBaseRelativePath(e.Location);
        if (!AuthService.IsAuthenticated && !relative.StartsWith("login", StringComparison.OrdinalIgnoreCase))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        StateHasChanged();
    }

    private bool IsActive(string route)
    {
        var relative = Navigation.ToBaseRelativePath(Navigation.Uri);
        return relative.StartsWith(route.TrimStart('/'), StringComparison.OrdinalIgnoreCase);
    }

    private void ToggleTheme()
    {
        ThemeService.ToggleTheme();
    }

    private void Logout()
    {
        AuthService.Logout();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        ThemeService.OnThemeChanged -= StateHasChanged;
        dotNetRef?.Dispose();
    }

    private DotNetObjectReference<MainLayout>? dotNetRef;
}